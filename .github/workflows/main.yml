name: Get Pzubslic IP

on:
  push:
    branches:
      - main

jobs:
  set-env:
    name: set-env
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: get SDK
        run: pip install huaweicloudsdkvpc
      - name: Get Public IP
        id: public-ip
        run:  echo "ip_address=$(dig +short myip.opendns.com @resolver1.opendns.com)\n" >> $GITHUB_OUTPUT
        
        
      - name: Run Python Script
        run: python script.py
        env:
          CLOUD_SDK_AK: ${{ secrets.CLOUD_SDK_AK }}
          CLOUD_SDK_SK: ${{ secrets.CLOUD_SDK_SK }}
          IP_ADDRESS:  ${{ steps.public_ip.outputs.ip_address }}
          SG_ID: ${{ secrets.SG_ID }}
      - name: Install SSH Client
        run: sudo apt-get install openssh-client -y

      - name: Set up SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_ACTIONS }}

      - name: Install Go on Host
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} 'sudo apt-get update && sudo apt-get install -y golang'
      - name: Clone Repository on Host
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} 'git clone https://github.com/Turkopat/actionstest.git /root/actionstest'
      - name: SSH into Host and Execute Commands
        run: |
          ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} 'cd /root/actionstest && \
                         go mod download && \
                         go build -o main . && \
                         ./main'
          
